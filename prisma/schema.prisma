// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/client"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  username      String?   @unique
  email         String?   @unique
  emailVerified DateTime?
  password      String?   // For credentials provider
  image         String?   // Profile picture
  bannerImage   String?   // Profile banner
  bio           String?   // User bio
  accentColor   String?   // Custom accent color (hex)
  xp            Int       @default(0) // Experience points
  level         Int       @default(1) // User level
  accounts      Account[]
  sessions      Session[]
  animeList     UserAnimeList[]
  mangaList     UserMangaList[]
  reviews       Review[]
  favoriteAnime UserFavoriteAnime[]
  favoriteManga UserFavoriteManga[]
  achievements  UserAchievement[]
  badges        UserBadge[]
  challenges    UserChallenge[]
  bingoCards    UserBingoCard[]
  activityPosts ActivityPost[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Anime {
  id             Int      @id @default(autoincrement())
  anilistId      Int?     @unique
  title          String
  titleRomaji    String?
  titleEnglish   String?
  titleNative    String?
  description    String?
  coverImage     String?
  bannerImage    String?
  status         String   // RELEASING, FINISHED, NOT_YET_RELEASED
  season         String?  // e.g. "Spring 2025"
  seasonYear     Int?
  format         String?  // TV, MOVIE, OVA, etc.
  episodes       Int?
  duration       Int?     // in minutes
  startDate      String?  // YYYY-MM-DD
  endDate        String?  // YYYY-MM-DD
  averageScore   Int?     // 0-100
  popularity     Int?
  source         String?  // ORIGINAL, MANGA, etc.
  studios        String?  // JSON array of studio names
  synonyms       String?  // JSON array of alternative titles
  tags           String?  // JSON array of tags
  countryOfOrigin String?
  isAdult        Boolean  @default(false)
  genres         Genre[]
  userLists      UserAnimeList[]
  reviews        Review[]
  favorites      UserFavoriteAnime[]
  activityPosts  ActivityPost[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Manga {
  id             Int      @id @default(autoincrement())
  anilistId      Int?     @unique
  title          String
  titleRomaji    String?
  titleEnglish   String?
  titleNative    String?
  description    String?
  coverImage     String?
  bannerImage    String?
  status         String   // RELEASING, FINISHED, NOT_YET_RELEASED
  format         String?  // MANGA, NOVEL, etc.
  chapters       Int?
  volumes        Int?
  startDate      String?  // YYYY-MM-DD
  endDate        String?  // YYYY-MM-DD
  averageScore   Int?     // 0-100
  popularity     Int?
  source         String?  // ORIGINAL, etc.
  synonyms       String?  // JSON array of alternative titles
  tags           String?  // JSON array of tags
  countryOfOrigin String?
  isAdult        Boolean  @default(false)
  genres         Genre[]
  userLists      UserMangaList[]
  reviews        Review[]
  favorites      UserFavoriteManga[]
  activityPosts  ActivityPost[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Genre {
  id     Int     @id @default(autoincrement())
  name   String  @unique
  animes Anime[]
  mangas Manga[]
}

model UserAnimeList {
  id          Int      @id @default(autoincrement())
  userId      String
  animeId     Int
  status      String   // WATCHING, PLANNING, DROPPED, COMPLETED, PAUSED
  currentEpisode Int?  // Current episode for WATCHING, PAUSED, DROPPED
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  anime       Anime    @relation(fields: [animeId], references: [id], onDelete: Cascade)

  @@unique([userId, animeId])
}

model UserMangaList {
  id          Int      @id @default(autoincrement())
  userId      String
  mangaId     Int
  status      String   // READING, PLANNING, DROPPED, COMPLETED, PAUSED
  currentChapter Int?  // Current chapter for READING, PAUSED, DROPPED
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  manga       Manga    @relation(fields: [mangaId], references: [id], onDelete: Cascade)

  @@unique([userId, mangaId])
}

model Review {
  id          Int      @id @default(autoincrement())
  userId      String
  animeId     Int?
  mangaId     Int?
  rating      Int      // 0-5 stars
  review      String?  // Review text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  anime       Anime?   @relation(fields: [animeId], references: [id], onDelete: Cascade)
  manga       Manga?   @relation(fields: [mangaId], references: [id], onDelete: Cascade)

  @@unique([userId, animeId])
  @@unique([userId, mangaId])
}

model UserFavoriteAnime {
  id        Int      @id @default(autoincrement())
  userId    String
  animeId   Int
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  anime     Anime    @relation(fields: [animeId], references: [id], onDelete: Cascade)

  @@unique([userId, animeId])
}

model UserFavoriteManga {
  id        Int      @id @default(autoincrement())
  userId    String
  mangaId   Int
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  manga     Manga    @relation(fields: [mangaId], references: [id], onDelete: Cascade)

  @@unique([userId, mangaId])
}

model Achievement {
  id          String   @id @default(cuid())
  code        String   @unique // e.g., "first_complete", "genre_master"
  name        String
  description String
  icon        String?  // Icon identifier
  xpReward    Int      @default(0)
  category    String   // "completion", "genre", "streak", "milestone", "challenge"
  rarity      String   @default("common") // "common", "rare", "epic", "legendary"
  createdAt   DateTime @default(now())
  
  users       UserAchievement[]
}

model UserAchievement {
  id            String      @id @default(cuid())
  userId        String
  achievementId String
  unlockedAt    DateTime    @default(now())
  progress      Int?        // Current progress if achievement is progressive
  
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  
  @@unique([userId, achievementId])
}

model Badge {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String
  icon        String?
  category    String   // "genre", "milestone", "special"
  rarity      String   @default("common")
  createdAt   DateTime @default(now())
  
  users       UserBadge[]
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  badgeId   String
  earnedAt  DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  
  @@unique([userId, badgeId])
}

model Challenge {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String
  type        String   // "daily", "weekly"
  category    String   // "genre", "episode_count", "completion", "watch_time"
  target      Int      // Target value (e.g., 3 shows, 10 episodes)
  targetGenre String?  // If genre-specific
  xpReward    Int      @default(0)
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  
  users       UserChallenge[]
}

model UserChallenge {
  id          String    @id @default(cuid())
  userId      String
  challengeId String
  progress    Int       @default(0)
  completed   Boolean   @default(false)
  completedAt DateTime?
  startedAt   DateTime  @default(now())
  
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  
  @@unique([userId, challengeId])
}

model BingoCard {
  id          String   @id @default(cuid())
  name        String   // e.g., "Spring 2025 Bingo"
  season      String   // "SPRING", "SUMMER", "FALL", "WINTER"
  year        Int
  squares     String   // JSON array of square definitions
  isActive    Boolean  @default(true)
  startDate   DateTime
  endDate     DateTime
  createdAt   DateTime @default(now())
  
  users       UserBingoCard[]
  
  @@unique([season, year])
}

model UserBingoCard {
  id            String    @id @default(cuid())
  userId        String
  bingoCardId   String
  markedSquares String    @default("[]") // JSON array of marked square indices
  completedAt   DateTime?
  startedAt     DateTime  @default(now())
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  bingoCard     BingoCard @relation(fields: [bingoCardId], references: [id], onDelete: Cascade)
  
  @@unique([userId, bingoCardId])
}

model News {
  id          String   @id @default(cuid())
  title       String
  description String?  // Summary/excerpt
  content     String?  // Full content if available
  link        String   @unique // Original article URL
  imageUrl    String?  // Featured image URL
  source      String   // "ANN", "MyAnimeList", "Crunchyroll", etc.
  category    String?  // "trailer", "announcement", "adaptation", "staff", "delay", "production"
  publishedAt DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([publishedAt])
  @@index([category])
  @@index([source])
}

model ActivityPost {
  id          String   @id @default(cuid())
  userId      String
  type        String   // "post", "episode", "chapter"
  content     String?  // User's text content (for "post" type)
  animeId     Int?
  mangaId     Int?
  episode     Int?     // Episode number (for "episode" type)
  chapter     Int?     // Chapter number (for "chapter" type)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  anime       Anime?   @relation(fields: [animeId], references: [id], onDelete: Cascade)
  manga       Manga?   @relation(fields: [mangaId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([userId])
  @@index([type])
}
